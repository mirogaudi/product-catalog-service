![SCC Code lines](https://sloc.xyz/github/mirogaudi/product-catalog-service/?category=code)
![GitHub top language](https://img.shields.io/github/languages/top/mirogaudi/product-catalog-service)
![GitHub maven workflow status](https://img.shields.io/github/actions/workflow/status/mirogaudi/product-catalog-service/maven.yml?branch=master)
![JaCoCo coverage](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/mirogaudi/product-catalog-service/master/.github/badges/jacoco.json)
![JaCoCo branches](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/mirogaudi/product-catalog-service/master/.github/badges/branches.json)
![GitHub license](https://img.shields.io/github/license/mirogaudi/product-catalog-service)

# Product Catalog Service with REST API

## Description

Application is a demo of a product catalog having simplified logic.

### Used technologies

- Java 25
- Maven 4 (wrapper)
- Maven BuildTime Profiler Extension
- Spring Boot
- Spring Web MVC
- Spring Cache (Caffeine)
- Spring Data JPA
- Flyway DB migration tool
- H2 DB
- Project Reactor
- Resilience4j
- Lombok
- Docker
- OpenAPI 3 & Swagger UI (springdoc-openapi)
- JUnit Jupiter
- Mockito
- JaCoCo
- CycloneDX SBOM
- OWASP

#### Misc

- Repository is licensed under [Apache License 2.0](https://www.apache.org/licenses/LICENSE-2.0.html)
- Repository uses GitHub Actions ([Java_CI_with_Maven](.github/workflows/maven.yml))
- Repository uses [Renovate](https://github.com/renovatebot/renovate) dependency updates ([via Renovate
  GitHub App](https://github.com/apps/renovate))
- Repository uses [Dependabot](https://github.com/dependabot) dependency
  updates ([see dependabot.yml](.github/dependabot.yml))
- Readme badges are rendered using [shields.io](https://github.com/badges/shields)
- JaCoCo badges sources are generated by [jacoco-badge-generator](https://github.com/cicirello/jacoco-badge-generator)
- LoC badge is generated by [SCC](https://github.com/boyter/scc)
- ER diagram is generated by [mermaid.live](https://mermaid.live)
- ASCII Art for [SpringBoot banner](src/main/resources/banner.txt) was generated
  with [TAAG](http://patorjk.com/software/taag) (font `Calvin S`)
- [SpringBoot custom Favicon](src/main/resources/static/favicon.ico) was generated
  with [favicon.cc](https://www.favicon.cc)

### Functionality

- Application implements CRUD operations for Categories and Products
- Category and Product services are `@Transactional` to avoid race condition
- Application gets currency exchange rates from Frankfurter [https://frankfurter.dev](https://frankfurter.dev)
    - Frankfurter REST API is called via Spring `RestTemplate` and decorated with Resilience4j `CircuitBreaker`
- Rates are cached with `Caffeine` during a period of their validity
    - Cache eviction is scheduled to `16:01 CET MON-FRI`

### Database

Application DB stores categorized products:

- Categories are multilevel *(i.e. `Computers` <-- `Portable computers` <-- `Tablets`)*
- Products can relate to multiple categories *(i.e. `MacBook` relates to `Notebook` and to `Apple`)*
- Product prices are stored in original and base currency *(i.e. original price in `USD` and calculated price in `EUR`)*

[![](https://mermaid.ink/img/pako:eNqtUs1ugzAMfhUr5_YFOG-79DJp10jITTyIBAkyySQEvPsCbVoYjF2Wm-3vxz_phXKaRCaIXwwWjLW08HgKPRWOO-iXWYCrKYz1YDS8X9aVL2RVIoPFmnY5DTJZnxu9rI7SLsOGnQ7K_4drqjieyFjlKnBsQHVrmA01sVFPWBOjX6SOFTbE_dnyP1abYHHYt8suIglsIT8cH07DAOczuOGZyUCKEtv7UaQ4ovWb1ie2ctajsW0qtmuRdMlDjStVzhYteJdMDc064iTiUms0On7QeU9S-JLijcXE0_SJoZrbHiM0NDqyX7XxjkXmOdBJYPDuo7MqxTfM_affkuM3QcjoYg)](https://mermaid.live/edit#pako:eNqtUs1ugzAMfhUr5_YFOG-79DJp10jITTyIBAkyySQEvPsCbVoYjF2Wm-3vxz_phXKaRCaIXwwWjLW08HgKPRWOO-iXWYCrKYz1YDS8X9aVL2RVIoPFmnY5DTJZnxu9rI7SLsOGnQ7K_4drqjieyFjlKnBsQHVrmA01sVFPWBOjX6SOFTbE_dnyP1abYHHYt8suIglsIT8cH07DAOczuOGZyUCKEtv7UaQ4ovWb1ie2ctajsW0qtmuRdMlDjStVzhYteJdMDc064iTiUms0On7QeU9S-JLijcXE0_SJoZrbHiM0NDqyX7XxjkXmOdBJYPDuo7MqxTfM_affkuM3QcjoYg)

DB migration is done with Flyway using scripts:

- [V1__create_schema.sql](src/main/resources/db/migration/V1__create_schema.sql)
    - initial script `target/classes/db/create_schema.sql` is generated with Spring Data JPA when starting
      application with `dev` profile (for details see [application-dev.yml](src/main/resources/application-dev.yml))
- [V2__insert_data.sql](src/main/resources/db/migration/V2__insert_data.sql)

Application uses H2 DB.

### Configuration

See application specific configuration in `pcs:` section of [application.yml](src/main/resources/application.yml)

## Getting started

### Maven build

```shell
# Build with Maven wrapper
$ ./mvnw package
```

#### Maven BuildTime Profiler Extension

The BuildTime Profiler Extension is activated by default. To deactivate the profiler extension for all maven builds just
uncomment the parameter `-Dmaven-build-time-profiler.disabled` in [maven.config](./.mvn/maven.config).

### Docker build

```shell
# Build and tag Docker image with Docker
# Firstly build artifact required by Docker with Maven Wrapper
$ ./mvnw package -DskipTests
# Secondly build with Docker
$ docker build -t mirogaudi/product-catalog-service:1.0.0 .
$ docker tag mirogaudi/product-catalog-service:1.0.0 mirogaudi/product-catalog-service:latest

# Or build Docker image with Maven wrapper via Docker plugin
$ ./mvnw package -Pdocker -DskipTests
```

### Run

#### Run with Java

```shell
# Run with Java
$ java -jar target/product-catalog-service-1.0.0.jar
```

#### Run with Maven

```shell
# Run with Maven wrapper (via Spring Boot plugin)
$ ./mvnw spring-boot:run
```

#### Run with Docker

```shell
# Run with Docker
$ docker run -it -d --rm --name product-catalog-service -p 8080:8080 mirogaudi/product-catalog-service:latest
```

#### Run in IDE

Just run in IDE: [ProductCatalogServiceApplication.java](./src/main/java/mirogaudi/productcatalog/ProductCatalogServiceApplication.java)

### View and try Application API

- OpenAPI docs: [http://localhost:8080/pcs/v3/api-docs](http://localhost:8080/pcs/v3/api-docs)
- Swagger UI: [http://localhost:8080/pcs/swagger-ui/index.html](http://localhost:8080/pcs/swagger-ui/index.html)
- HTTP client: [request-categories.http](http-requests/request-categories.http), [request-products.http](http-requests/request-products.http)

#### Spring Boot Actuator

- Actuator: [http://localhost:9000/actuator](http://localhost:9000/actuator)
- Swagger UI: [http://localhost:8080/pcs/swagger-ui/index.html?urls.primaryName=x-actuator](http://localhost:8080/pcs/swagger-ui/index.html?urls.primaryName=x-actuator)
- HTTP client: [request-actuator.http](http-requests/request-actuator.http)

### View DB

- H2 console [http://localhost:8080/pcs/h2-console](http://localhost:8080/pcs/h2-console)
    - url: `jdbc:h2:file:./target/db/pcs;AUTO_SERVER=TRUE`
    - username: `sa`
    - password: `<empty>`

## Code quality

### Static code analysis

```shell
# Build performing static code analysis
$ ./mvnw package -Pcheckstyle,pmd,spotbugs -DskipTests
```

#### Checkstyle

Project uses [checkstyle.xml](checkstyle.xml) configuration based on customized
Checkstyle [google_checks.xml](https://github.com/checkstyle/checkstyle/blob/master/src/main/resources/google_checks.xml).

```shell
# Build checking with Checkstyle
$ ./mvnw validate -Pcheckstyle -DskipTests
```

#### PMD

```shell
# Build checking with PMD
$ ./mvnw package -Ppmd -DskipTests
```

#### SpotBugs

```shell
# Build checking with SpotBugs
$ ./mvnw package -Pspotbugs -DskipTests
```

### Code coverage

```shell
# Build generating JaCoCo code coverage report and checking code coverage metrics
$ ./mvnw package -Pcode-coverage
```

### Software Bill of Materials (SBOM)

#### CycloneDX SBOM

```shell
# Build generating CycloneDX SBOM
$ ./mvnw package -Psbom -DskipTests
```

Generated SBOM can be reviewed:

- as file [./target/classes/META-INF/sbom/application.cdx.json](./target/classes/META-INF/sbom/application.cdx.json)
- or via SBOM Actuator Endpoint [http://localhost:9000/actuator/sbom/application](http://localhost:9000/actuator/sbom/application)

  (Just rerun Application with [Java](#run-with-java) or [Maven](#run-with-maven))

### Dependencies vulnerabilities

#### OWASP

```shell
# Build generating OWASP dependency vulnerability report
$ ./mvnw package -Powasp -DskipTests
```

#### Snyk

Snyk analysis can be viewed at snyk.io: [Snyk Test Results](https://snyk.io/test/github/mirogaudi/product-catalog-service)

## Maintenance

### Update dependencies

Dependencies are to be updated automatically with Renovate/Dependabot or could be updated manually.

#### Update Maven Wrapper

```shell
# Update Maven wrapper to use Maven a.b.c 
$ mvn wrapper:wrapper -Dmaven=<a.b.c>
```

#### Check for new versions with `versions-maven-plugin`

```shell
# Check for Maven plugins updates
$ ./mvnw versions:display-plugin-updates

# Check for Maven parent updates
$ ./mvnw versions:display-parent-updates

# Check for Maven property-linked dependencies updates
$ ./mvnw versions:display-property-updates

# Check for Maven dependencies updates
$ ./mvnw versions:display-dependency-updates
```

To ignore case-insensitive `alpha`, `beta`, `dev`, `milestone` and `release candidate` versions in checks above add the following D-parameter:
`maven.version.ignore='(?i).*[-.](alpha|beta|dev|m|rc)([-.]?\d+)?'`

```shell
$ ./mvnw -Dmaven.version.ignore='(?i).*[-.](alpha|beta|dev|m|rc)([-.]?\d+)?' versions:<goal>
```

## TODO:

- update to SB 4.0
- add semantic releases and/or CHANGELOG.md https://keepachangelog.com/
- clean up:
  - Use WebClient or declarative web call instead of RestTemplate
  - Use Flyway with maven plugin instead of dev app props
  - check if all transactions are valid and using proxy classes
  - check cache test
  - Circuit Breaker -> use https://spring.io/guides/gs/cloud-circuit-breaker, test it
  - configure logback
  - Use Rest Assured for integration testing
  - test db with integration testing
  - add price history

- add PATCH call to update price
